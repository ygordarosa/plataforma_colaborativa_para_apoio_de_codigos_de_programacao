<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snippets</title>
    <link rel="stylesheet" href="css/style_unificado.css">
</head>

<body>
    <header class="navbar">
        <div class="left-group">
            <div class="logo">
                <a href="home.html">
                    <img src="img/Logo.png" alt="Logo">
                </a>
            </div>

            <form class="search-container" id="searchForm">
                <input type="text" id="search-input" name="search" placeholder="Pesquisar...">
                <button type="submit">üîç</button>
            </form>

            <div class="button-home">
                <a href="listing.html"><button>Snippets</button></a>
            </div>
        </div>

        <div class="buttons-right" id="auth-buttons">
            <!-- Login / Logout / Criar Snippet controlados via JS futuramente -->
        </div>
    </header>

    <div id="main">
        <div id="sub-header">
            <a href="home.html"><button type="button">Voltar</button></a>
            <div id="gray-bar"></div>
            <h1 id="snippet-title">Todos os Snippets</h1>
        </div>

        <!-- FILTRO POR LINGUAGEM -->
        <div class="languages">
            <h2 class="language-filter-text">Filtros:</h2>
            <div class="language-buttons">
                <form><input type="hidden" name="filter" value="python" ><button type="submit" id="python-button">Python</button></form>
                <form><input type="hidden" name="filter" value="javascript" ><button type="submit" id="javascript-button">JavaScript</button></form>
                <form><input type="hidden" name="filter" value="java" ><button type="submit" id="java-button">Java</button></form>
                <form><input type="hidden" name="filter" value="csharp" ><button type="submit" id="csharp-button">C#</button></form>
                <form><input type="hidden" name="filter" value="all" ><button type="submit" id="all-button">Todos</button></form>
            </div>
        </div>

        <!-- LISTAGEM DE SNIPPETS -->
        <div class="listing-snippets">
            <p>Carregando snippets...</p>
        </div>
    </div>
</body>

<script>
const LAMBDA_URL = "https://2iz8svjpw8.execute-api.us-east-1.amazonaws.com/listing";

document.addEventListener("DOMContentLoaded", async function () {
    const listingContainer = document.querySelector(".listing-snippets");
    const filterForms = document.querySelectorAll(".language-buttons form");
    const title = document.getElementById("snippet-title");

    function renderSnippets(snippets) {
        listingContainer.innerHTML = "";
        if (!snippets || snippets.length === 0) {
            listingContainer.innerHTML = "<p>Nenhum snippet encontrado.</p>";
            return;
        }
        snippets.forEach(snip => {
            const snippetHTML = `
                <a href="snippet.html?id=${snip.id}">
                    <div class="snippet-resume" data-language="${snip.language}">
                        <div class="snippet-header">
                            <h3 class="snippet-resume-title">${snip.title}</h3>
                            <img src="/static/img/${snip.language}.png" alt="${snip.language}" class="snippet-resume-language-logo">
                        </div>
                        <p class="snippet-resume-description">${snip.description}</p>
                        <div class="snippet-resume-like">
                            <img src="/static/img/like.png" alt="">
                            <p>${snip.like}</p>
                        </div>
                        <div class="snippet-resume-deslike">
                            <img src="/static/img/deslike.png" alt="">
                            <p>${snip.deslike}</p>
                        </div>
                    </div>
                </a>
            `;
            listingContainer.insertAdjacentHTML("beforeend", snippetHTML);
        });
    }

    async function fetchSnippets(payload) {
        const options = payload ? {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        } : {};
        const response = await fetch(LAMBDA_URL, options);
        const data = await response.json();
        renderSnippets(data);
    }

    const searchForm = document.querySelector(".search-container");
    const searchInput = searchForm.querySelector("input[name='search']");

    // 1Ô∏è‚É£ Pega a query da URL e preenche o input
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get("search");
    if(query) {
        searchInput.value = query;
        title.textContent = "Pesquisa: " + query;
        fetchSnippets({ search: query });
    } else {
        fetchSnippets(); // sem query, lista tudo
    }

    // 2Ô∏è‚É£ Listener do formul√°rio de busca
    searchForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const search = searchInput.value.trim();
        if(!search) {
            fetchSnippets();
            return;
        }
        // Atualiza a URL para ficar consistente
        window.history.replaceState({}, "", `listing.html?search=${encodeURIComponent(search)}`);
        title.textContent = "Pesquisa: " + search;
        fetchSnippets({ search: search });
    });

    // 3Ô∏è‚É£ Filtros de linguagem
    filterForms.forEach(form => {
        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const filter = this.querySelector("input[name='filter']").value;
            title.textContent = filter === "all" ? "Todos os Snippets" : "Linguagem: " + filter;
            fetchSnippets(filter === "all" ? null : { filter_language: filter });
        });
    });
});

        function renderHeader() {
            const user = JSON.parse(localStorage.getItem("user"));
            const headerButtons = document.getElementById("auth-buttons");
            headerButtons.innerHTML = "";

            if (user) {
                headerButtons.innerHTML = `
                    <span style="margin-right:10px;">Ol√°, ${user.name}</span>
                    <a href="snippet-form.html"><button>Criar Snippet</button></a>
                    <button onclick="logout()">Logout</button>
                `;
            } else {
                headerButtons.innerHTML = `
                    <a href="login-form.html"><button>Login</button></a>
                    <a href="register-form.html"><button>Registrar</button></a>
                `;
            }
        }

        function logout() {
            localStorage.removeItem("user");
            renderHeader();
        }

        renderHeader()
</script>


</html>
